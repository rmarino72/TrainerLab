@page
@{}
<br />
<br />
<div class="col-lg-12" id="mainPg">

    <div class="container">
        <div class="card mb-0">
            <div class="card-header">
                <h3 class="h4 mb-0"><span class="material-symbols-outlined">group</span>&nbsp; Gestione Utenti</h3>
            </div>
            <div class="card-body pt-0">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" id="new-btn"><span class="material-symbols-outlined">add</span>&nbsp; Nuovo</button>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0 table-striped table-sm" data-mobile-responsive="true" id="dataTable">
                        <thead>
                            <tr>
                                <th data-field="id">#</th>
                                <th data-field="firstName">Nome</th>
                                <th data-field="lastName">Cognome</th>
                                <th data-field="email">Email</th>
                                <th data-field="birthDate">Data di nascita</th>
                            </tr>
                        </thead>
                        <tbody role="button"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container" id="editPg">
    <div class="col-lg-12">
        <div class="card mb-0">
            <div class="card-header">
                <h3 class="h4 mb-0"><span class="material-symbols-outlined">group</span>&nbsp; Dettaglio Utente</h3>
            </div>
            <div class="card-body pt-0">
                <form id="editForm" action="none" method="get">
                    <input type="hidden" id="id-txt" />
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="firstName-txt">Nome *</label>
                                <input class="form-control" id="firstName-txt" type="text" name="firstNameTxt" autocomplete="off" required data-validate-field="firstNameTxt">

                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="lastName-txt">Cognome *</label>
                                <input class="form-control" id="lastName-txt" type="text" name="lastNameTxt" autocomplete="off" required data-validate-field="lastNameTxt">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="role-cmb">Ruolo *</label>
                                <select class="form-control" id="role-cmb" name="roleCmb" required data-validate-field="roleCmb">
                                    <option value=""> - </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="email-txt">Email *</label>
                                <input class="form-control" id="email-txt" type="text" name="phoneTxt" autocomplete="off" required data-validate-field="emaiTxt">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="phone-txt">Telefono *</label>
                                <input class="form-control" id="phone-txt" type="text" name="phoneTxt" autocomplete="off" required data-validate-field="phoneTxt">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="birthDate-txt">Data di Nascita *</label>
                                <input class="form-control" id="birthDate-txt" type="date" name="birthDateTxt" autocomplete="off" required data-validate-field="birthDateTxt">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="sex-cmb">Genere *</label>
                                <select class="form-control" id="sex-cmb" name="sexCmb" required data-validate-field="sexCmb">
                                    <option value=""> - </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="region-cmb">Regione</label>
                                <select class="form-control" id="region-cmb">
                                    <option value=""> - </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="province-cmb">Provincia</label>
                                <select class="form-control" id="province-cmb">
                                    <option value=""> - </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="city-cmb">Comune</label>
                                <select class="form-control" id="city-cmb">
                                    <option value=""> - </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="cap-txt">CAP</label>
                                <input class="form-control" id="cap-txt" type="text">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="address-txt">Via / Piazza</label>
                                <input class="form-control" id="address-txt" type="text">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="input-material-group col-lg-12">
                                <label class="form-label" for="number-txt">N.</label>
                                <input class="form-control" id="number-txt" type="text">
                            </div>
                        </div>
                    </div>

                    <hr />
                    <button class="btn btn-primary" type="button" id="cancel-btn"><span class="material-symbols-outlined">close</span>&nbsp; Annulla</button>
                    <button class="btn btn-primary" type="submit"><span class="material-symbols-outlined">done</span>&nbsp; Ok</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    function init() {
        $('#editPg').hide();
        $('#region-cmb').change(loadProvinces);
        $('#province-cmb').change(loadCities);
        $('#city-cmb').change(refreshCap);
        $('#new-btn').click(prepareForNew);
        $('#cancel-btn').click(refreshPage);

        let rules = {
            emaiTxt: {
                required: true,
                email: true,
            },
            phoneTxt: {
                required: true,
                phone: true,
            },
            firstNameTxt: {
                required: true,
            },
            lastNameTxt: {
                required: true,
            },
            birthDateTxt: {
                required: true,
                date: true,
            },
            sexCmb: {
                required: true
            },
            roleCmb: {
                required: true
            }
        };

        let messages = {
            emaiTxt: "Inserire una mail valida",
            phoneTxt: "Inserire un numero di telefono valido",
            firstNameTxt: "Campo obbligatorio",
            lastNameTxt: "Campo obbligatorio",
            birthDateTxt: "Inserire una data valida",
            sexCmb: "Campo obbligatorio",
            roleCmb: "Campo obbligatorio",
        }

        validateForm('editForm', rules, messages);
        ajaxCall(USER_FULL, 'GET', null, gotUsers);
    }

    function gotUsers(data) {

        data.data.forEach(e => {
            e.birthDate = italianFormatDate(new Date(e.birthDate));
        });

        fillDataTable('dataTable', data.data, userDetail, true);
        ajaxCall(USER_SEX, 'GET', null, gotSex);
    }

    function gotSex(data) {
        if (!data.outcome) {
            alertify.error(data.message);
            return;
        }
        data.data.forEach(e => {
            $('#sex-cmb').append($('<option/>', {
                value: e.name,
                text: e.labelIT
            }));
        });
        
    }

    function loadRoles() {
        ajaxCall(USER_ROLE, 'GET', null, gotRoles);
    }

    function gotRoles(data) {
        if (!data.outcome) {
            alertify.error(data.message);
            return;
        }
        data.data.forEach(e => {
            $('#role-cmb').append($('<option/>', {
                value: e.name,
                text: e.labelIT
            }));
        });

        loadRegions();
    }

    function loadRegions()
    {
        ajaxCall(USER_REGION, 'GET', null, gotRegions);
    }

    function gotRegions(data) {
        if (!data.outcome) {
            alertify.error(data.message);
            return;
        }
        data.data.forEach(e => {
            $('#region-cmb').append($('<option/>', {
                value: e.value,
                text: e.value
            }));
        });
    }

    function userDetail(row) {
        var user = row.email;
        alert(user);
    }

    function loadProvinces() {
        resetSelect('province-cmb');
        resetSelect('city-cmb');
        $('#province-cmb').append($('<option/>', {
            value: "",
            text: "-"
        }));
        $('#city-cmb').append($('<option/>', {
            value: "",
            text: "-"
        }));
        refreshCap();
        if (!isEmpty($('#region-cmb').val())) {
            ajaxCall(USER_PROVINCE + $('#region-cmb').val(), 'GET', null, gotProvinces);
        }
    }

    function gotProvinces(data) {
        if (!data.outcome) {
            alertify.error(data.message);
            return;
        }

        data.data.forEach(e => {
            $('#province-cmb').append($('<option/>', {
                value: e.abbreviation,
                text: e.name
            }));
        });
    }

    function loadCities() {
        resetSelect('city-cmb');
        $('#city-cmb').append($('<option/>', {
            value: "",
            text: "-"
        }));
        refreshCap()
        if (!isEmpty($('#province-cmb').val())) {
            ajaxCall(USER_CITY + $('#province-cmb').val(), 'GET', null, gotCities);
        }
    }

    function gotCities(data) {
        if (!data.outcome) {
            alertify.error(data.message);
            return;
        }

        data.data.forEach(e => {
            $('#city-cmb').append($('<option/>', {
                value: e.cap,
                text: e.name
            }));
        });
    }

    function prepareForNew()
    {
        resetForm("editForm");

        loadRoles();
        $('#mainPg').hide();
        $('#editPg').show();
    }


    function refreshCap() {
        $('#cap-txt').val($('#city-cmb').val());
    }
</script>